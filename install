#!/bin/bash
# RaspberryPi MediaCentre Installer
# Author: Alan Pich
# Website: https://github.com/alanpich
# Date: 13 June 2012
# Version 1.0


################################################################################
###   V A R I A B L E   D E F I N I T I O N S                                  #
################################################################################

ZIPURL="https://github.com/alanpich/rPI-media-centre/zipball/master"
RPIMC_PATH="/etc/rPImc"
USER=exec whoami
GROUP="rpi-mc"




################################################################################
###   U S E F U L   F U N C T I O N S                                          #
################################################################################

# PAD A STRING TO 
function pad {
	echo -n "  "$1"..." | sed -e :a -e 's/^.\{1,32\}$/& /;ta'
} 


# CHECK FOR A PACKAGE, INSTALL IT IF NOT FOUND
function require {
	pad "Checking $1"
	if which $1 >/dev/null; then
		success
	else
		fail
		# Install quietly without confirmation prompts
		# sudo apt-get -qy install $1 >/dev/tty1
	fi
}

# COLOURED OUTPUT 
function purp {	echo -e "\e[01;35m$*\e[00m" ;}
function fail {	echo -e "\e[01;31mNO\e[00m";}
function success {	echo -e "\e[00;32mOK\e[00m";}




################################################################################
###   M A I N   I N S T A L L E R   S C R I P T                                #
################################################################################

clear;
purp "---------------------------------------------------"
purp "::             RaspberryPi MediaCenter           ::"
purp "---------------------------------------------------"
echo " This script will install all required packages to "
echo " run a media centre on your rPI and control it via "
echo " a web interface."
echo

# REDUNDANT SUDO COMMAND TO CACHE PASSWORD
echo " Installation requires root (sudo) privileges."
echo " Please enter your password"
sudo ls >/dev/null


# CHECK FOR ALL REQUIRED PACKAGES AND INSTALL ANY MISSING
echo
purp " :: CHECKING DEPENDENCIES"
purp " ----------------------------------"
require apache2
require php5
require php5-cli
require mysql-
require fusesmb
require unzip
echo

# GET NESCESARY FILES AND EXTRACT TO THE CORRECT PLACES 
purp " :: INSTALLING INTERFACE"
purp " ----------------------------------"

# CREATE USER GROUP IF IT DOESNT EXISTS
pad "Adding group $GROUP"
TMP=`egrep -i "^$GROUP" /etc/group`
if [ $TMP = "" ]; then
	sudo groupadd $GROUP
fi
success

# CREATE INSTALL DIRECTORY IF IT DOESNT EXIST
pad "Checking install path"
if [ ! -e $RPIMC_PATH ]; then
	sudo mkdir $RPIMC_PATH
fi
success

# CHOWN INSTALL DIR TO SPECIFIED USER AND GROUP
pad "Checking permissions"
sudo chown  $USER:$GROUP $RPIMC_PATH
success

# DOWNLOAD LATEST BUILD FROM GITHUB
pad "Downloding git repo"
wget -q $ZIPURL 
mv master rPI-media-centre.zip
success

# EXTRACT FILES TO INSTALL PATH
pad "Extracting archive"
unzip -qq -o rPI-media-centre.zip -d $RPIMC_PATH

# ORGANISE FILES PROPERLY
DIR=`ls $RPIMC_PATH | sort -n | head -1`
mv $RPIMC_PATH/$DIR/* $RPIMC_PATH
rm -rf $RPIMC_PATH/$DIR
success
echo

# SET UP APACHE TO SERVE THE CORRECT DIRECTORIES
purp " :: SETTING UP APACHE (to do)"
purp " ----------------------------------"
pad "Setting up envvars" && success
pad "Setting up sites-available" && success
pad "Enabling mod_rewrite" && success
echo

# SET UP USER .profile WITH ALIASES & NETWORK MOUNT
purp " :: SETTING UP USER ENVIRONMENT (to do)"
purp " ----------------------------------"
pad "Adding startup scripts" && success
pad "Mounting network shares" && success
pad "Restarting apache service" 
sudo service apache2 restart >/dev/null && success


echo
